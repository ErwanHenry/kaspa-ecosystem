<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Ecosystem - Discover Projects Building on Kaspa</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: #0F172A; 
            color: #CBD5E1; 
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Navigation */
        .nav { 
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(10px);
            padding: 16px 0; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
        }
        .nav-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        .logo { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #49EACB; 
            text-decoration: none; 
        }
        
        /* Buttons */
        .btn { 
            padding: 8px 16px; 
            background: #49EACB; 
            color: #0F172A; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { 
            background: #6FFDD8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #334155;
            color: #CBD5E1;
        }
        .btn-secondary:hover {
            background: #475569;
        }
        
        /* Hero */
        .hero { 
            text-align: center; 
            padding: 60px 20px; 
            background: linear-gradient(180deg, transparent, rgba(73, 234, 203, 0.02));
        }
        .hero h1 { 
            font-size: 2.5rem; 
            margin-bottom: 16px; 
        }
        .gradient { 
            background: linear-gradient(135deg, #49EACB, #6FFDD8); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .hero p {
            color: #94A3B8;
            font-size: 1.125rem;
            margin-bottom: 30px;
        }
        
        /* Stats */
        .stats { 
            display: flex; 
            justify-content: center; 
            gap: 60px; 
            margin: 40px 0; 
        }
        .stat { text-align: center; }
        .stat-num { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #49EACB; 
        }
        .stat-label { 
            font-size: 0.9rem; 
            color: #94A3B8; 
        }
        
        /* Section */
        .section {
            margin: 60px 0;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .section-title {
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* Grid */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
            margin-bottom: 40px;
        }
        
        /* Card */
        .card { 
            background: #1E293B; 
            border: 1px solid #334155; 
            border-radius: 8px; 
            padding: 20px; 
            transition: all 0.2s; 
            cursor: pointer;
        }
        .card:hover { 
            transform: translateY(-4px); 
            border-color: #49EACB; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #49EACB, #2BC9AA);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            color: #0F172A;
        }
        .card h3 { 
            margin-bottom: 4px; 
            font-size: 1.125rem;
        }
        .card-category {
            font-size: 0.75rem;
            color: #49EACB;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .card p { 
            color: #94A3B8; 
            font-size: 0.9rem; 
            margin-bottom: 16px; 
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card a { 
            color: #49EACB; 
            text-decoration: none; 
            font-weight: 500;
        }
        .card a:hover { 
            text-decoration: underline; 
        }
        
        /* Tags */
        .tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .tag {
            background: #0F172A;
            color: #64748B;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        /* Loading & Error */
        .loading { 
            text-align: center; 
            padding: 60px; 
            color: #49EACB; 
        }
        .error { 
            background: #7F1D1D; 
            color: #FCA5A5; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            margin: 20px 0;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: auto;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            padding: 20px;
        }
        .close {
            font-size: 28px;
            color: #94A3B8;
            cursor: pointer;
            background: none;
            border: none;
        }
        .close:hover {
            color: #CBD5E1;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #0F172A;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #CBD5E1;
            font-size: 16px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #49EACB;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .required {
            color: #EF4444;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px 20px;
            display: none;
            z-index: 2000;
            min-width: 300px;
        }
        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        .toast.success {
            border-color: #10B981;
            color: #10B981;
        }
        .toast.error {
            border-color: #EF4444;
            color: #EF4444;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) { 
            .hero h1 { font-size: 2rem; } 
            .stats { flex-direction: column; gap: 20px; } 
            .grid { grid-template-columns: 1fr; }
            .section-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <a href="/" class="logo">⚡ Kaspa Ecosystem</a>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="showSubmitModal()">+ Submit Project</button>
                <a href="/admin-complete.html" class="btn btn-secondary">Admin</a>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <div class="hero">
        <h1>Discover the <span class="gradient">Kaspa Ecosystem</span></h1>
        <p>Explore wallets, mining tools, DeFi protocols, and innovative projects building on the fastest proof-of-work blockchain</p>
        
        <div class="stats" id="stats">
            <div class="stat">
                <div class="stat-num" id="total-projects">0</div>
                <div class="stat-label">Projects</div>
            </div>
            <div class="stat">
                <div class="stat-num" id="total-categories">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat">
                <div class="stat-num" id="total-users">0</div>
                <div class="stat-label">Contributors</div>
            </div>
        </div>
    </div>

    <!-- Projects Section -->
    <div class="container">
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">All Projects</h2>
                <input type="text" id="search" placeholder="Search projects..." 
                       style="padding: 10px; background: #1E293B; border: 1px solid #334155; 
                              border-radius: 6px; color: #CBD5E1; width: 300px; max-width: 100%;"
                       onkeyup="searchProjects(this.value)">
            </div>
            
            <div id="loading" class="loading">
                <div style="font-size: 2rem; margin-bottom: 10px;">⏳</div>
                Loading projects...
            </div>
            <div id="error" style="display:none" class="error"></div>
            <div id="projects" class="grid" style="display:none"></div>
            <div id="no-results" style="display:none; text-align: center; padding: 60px; color: #94A3B8;">
                No projects found
            </div>
        </section>
    </div>

    <!-- Submit Modal -->
    <div id="submit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit New Project</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="submit-form" onsubmit="submitProject(event)">
                    <div class="form-group">
                        <label>Project Name <span class="required">*</span></label>
                        <input type="text" name="name" required maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Category <span class="required">*</span></label>
                        <select name="category" required id="category-select">
                            <option value="">Select a category</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Description <span class="required">*</span></label>
                        <textarea name="description" required maxlength="500"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Website URL <span class="required">*</span></label>
                        <input type="url" name="url" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Logo URL (optional)</label>
                        <input type="url" name="logo_url">
                    </div>
                    
                    <div class="form-group">
                        <label>Twitter Handle (optional)</label>
                        <input type="text" name="twitter" placeholder="username without @">
                    </div>
                    
                    <div class="form-group">
                        <label>Submitter Email (optional)</label>
                        <input type="email" name="submitter_email">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;" id="submit-btn">
                        Submit Project
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://kxdngctxlxrbjhdtztuu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4ZG5nY3R4bHhyYmpoZHR6dHV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNDU3MzYsImV4cCI6MjA2OTkyMTczNn0.N_jgf3Q2R98-FqsYpz7sns9CwOnViuQBXFoA0TcmWSM';
        
        let allProjects = [];
        let categories = {};
        let supabaseClient;
        
        // Initialize
        async function init() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const projectsDiv = document.getElementById('projects');
            
            try {
                console.log('Initializing Supabase...');
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                
                console.log('Loading data...');
                // Load categories and projects
                const [categoriesRes, projectsRes] = await Promise.all([
                    supabaseClient.from('categories').select('*').order('name'),
                    supabaseClient.from('projects').select('*').order('created_at', { ascending: false })
                ]);
                
                console.log('Categories:', categoriesRes);
                console.log('Projects:', projectsRes);
                
                if (categoriesRes.error) {
                    console.warn('Categories table not found, using default categories');
                    // Use default categories if table doesn't exist
                    categories = {
                        'Wallets': { id: 1, name: 'Wallets' },
                        'Mining': { id: 2, name: 'Mining' },
                        'DeFi': { id: 3, name: 'DeFi' },
                        'NFTs': { id: 4, name: 'NFTs' },
                        'Infrastructure': { id: 5, name: 'Infrastructure' },
                        'Education': { id: 6, name: 'Education' },
                        'Tools': { id: 7, name: 'Tools' },
                        'Core': { id: 8, name: 'Core' },
                        'Wallet': { id: 9, name: 'Wallet' },
                        'Other': { id: 10, name: 'Other' }
                    };
                } else {
                    // Process categories from database
                    categoriesRes.data?.forEach(c => {
                        categories[c.id] = c;
                    });
                }
                
                if (projectsRes.error) throw projectsRes.error;
                
                // Populate category select
                const select = document.getElementById('category-select');
                const categoryOptions = Object.values(categories)
                    .filter((cat, index, self) => 
                        index === self.findIndex((c) => c.name === cat.name)
                    )
                    .sort((a, b) => a.name.localeCompare(b.name));
                    
                select.innerHTML = '<option value="">Select a category</option>' +
                    categoryOptions.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                
                // Process projects
                allProjects = (projectsRes.data || []).filter(p => p && p.name);
                
                // Update stats
                document.getElementById('total-projects').textContent = allProjects.length;
                document.getElementById('total-categories').textContent = categoryOptions.length;
                const uniqueUsers = new Set(allProjects.map(p => p.submitter_wallet || p.submitter_email).filter(Boolean));
                document.getElementById('total-users').textContent = uniqueUsers.size;
                
                // Render projects
                renderProjects(allProjects);
                
                loading.style.display = 'none';
                projectsDiv.style.display = 'grid';
                
            } catch (err) {
                console.error('Error:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.innerHTML = `
                    <h3>Error Loading Projects</h3>
                    <p>${err.message}</p>
                    <button class="btn" onclick="location.reload()" style="margin-top: 10px;">Retry</button>
                `;
            }
        }
        
        // Render projects
        function renderProjects(projects) {
            const projectsDiv = document.getElementById('projects');
            const noResults = document.getElementById('no-results');
            
            if (projects.length === 0) {
                projectsDiv.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            projectsDiv.style.display = 'grid';
            noResults.style.display = 'none';
            
            projectsDiv.innerHTML = projects.map(p => {
                const firstLetter = (p.name || '?').charAt(0).toUpperCase();
                const logoHtml = p.logo_url 
                    ? `<img src="${p.logo_url}" alt="${p.name}" style="width: 48px; height: 48px; border-radius: 8px; object-fit: cover;">`
                    : `<div class="card-icon">${firstLetter}</div>`;
                
                const tagsHtml = p.tags && Array.isArray(p.tags) && p.tags.length > 0
                    ? `<div class="tags">${p.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
                    : '';
                
                return `
                    <div class="card" onclick="window.open('${p.url}', '_blank')">
                        <div class="card-header">
                            ${logoHtml}
                            <div style="flex: 1;">
                                <h3>${p.name}</h3>
                                <div class="card-category">${p.category || 'Other'}</div>
                            </div>
                        </div>
                        <p>${p.description || 'No description available'}</p>
                        ${tagsHtml}
                        <div class="card-footer">
                            <a href="${p.url}" target="_blank" onclick="event.stopPropagation()">Visit →</a>
                            <small style="color: #64748B;">${new Date(p.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Search projects
        function searchProjects(query) {
            const filtered = allProjects.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) ||
                (p.description || '').toLowerCase().includes(query.toLowerCase()) ||
                (p.category || '').toLowerCase().includes(query.toLowerCase()) ||
                (p.tags && p.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())))
            );
            renderProjects(filtered);
        }
        
        // Show submit modal
        function showSubmitModal() {
            document.getElementById('submit-modal').classList.add('show');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('submit-modal').classList.remove('show');
            document.getElementById('submit-form').reset();
        }
        
        // Submit project
        async function submitProject(event) {
            event.preventDefault();
            
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            try {
                const formData = new FormData(event.target);
                const projectData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    url: formData.get('url'),
                    category: formData.get('category'),
                    logo_url: formData.get('logo_url') || null,
                    twitter: formData.get('twitter') || null,
                    submitter_email: formData.get('submitter_email') || null,
                    tags: [],
                    rating_avg: 0,
                    rating_count: 0,
                    verified: false,
                    views: 0,
                    average_rating: 0,
                    comment_count: 0
                };
                
                // Map category to category_id if it exists
                const categoryObj = Object.values(categories).find(c => c.name === projectData.category);
                if (categoryObj) {
                    projectData.category_id = categoryObj.id;
                }
                
                console.log('Submitting project:', projectData);
                
                const { data, error } = await supabaseClient
                    .from('projects')
                    .insert([projectData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Project submitted successfully!', 'success');
                closeModal();
                
                // Reload projects
                setTimeout(() => location.reload(), 1500);
                
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Failed to submit project', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Project';
            }
        }
        
        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('submit-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
