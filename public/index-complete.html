<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Ecosystem - Discover Projects Building on Kaspa</title>
    <meta name="description" content="Explore the growing ecosystem of projects building on Kaspa blockchain.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/kaspa-ecosystem.css">
    
    <style>
        /* Critical CSS for fast initial render */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0F172A;
            color: #CBD5E1;
            line-height: 1.6;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0F172A;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid #1E293B;
            border-top-color: #49EACB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="color: #49EACB; margin-top: 20px;">‚ö° Loading Kaspa Ecosystem...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <a href="/" class="brand-link">
                        <span class="brand-icon">‚ö°</span>
                        <span class="brand-text">Kaspa Ecosystem</span>
                    </a>
                </div>
                
                <div class="nav-menu" id="navMenu">
                    <a href="#featured" class="nav-link">Featured</a>
                    <a href="#projects" class="nav-link">Projects</a>
                    <a href="#categories" class="nav-link">Categories</a>
                </div>
                
                <div class="nav-actions">
                    <button class="btn btn-primary btn-sm" onclick="showSubmitModal()">
                        <i class="fas fa-plus"></i> Submit Project
                    </button>
                    <button class="btn btn-secondary btn-sm" id="walletBtn" onclick="showWalletModal()">
                        <i class="fas fa-wallet"></i>
                        <span id="wallet-status">Connect</span>
                    </button>
                    <button class="nav-toggle" id="navToggle" onclick="toggleMobileMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-background">
                <div class="grid-pattern"></div>
            </div>
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">
                        Discover the <span class="text-gradient">Kaspa Ecosystem</span>
                    </h1>
                    <p class="hero-subtitle">
                        Explore wallets, mining tools, DeFi protocols, and innovative projects building on the fastest proof-of-work blockchain
                    </p>
                    <div class="hero-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-projects">0</span>
                            <span class="stat-label">Projects</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-categories">0</span>
                            <span class="stat-label">Categories</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="active-users">0</span>
                            <span class="stat-label">Active Users</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Featured Projects Carousel -->
        <section id="featured" class="featured-section" style="display: none;">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-star"></i> Featured Projects
                    </h2>
                    <p class="section-subtitle">Community-sponsored projects showcasing the best of Kaspa</p>
                </div>
                
                <div class="carousel-wrapper">
                    <div class="carousel-container" id="featuredCarousel">
                        <div class="carousel-track" id="carouselTrack">
                            <!-- Featured projects will be loaded here -->
                        </div>
                    </div>
                    <button class="carousel-control prev" onclick="moveCarousel(-1)" aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-control next" onclick="moveCarousel(1)" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="categories-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-th-large"></i> Browse by Category
                    </h2>
                </div>
                <div class="categories-grid" id="categoriesGrid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="projects-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-cube"></i> All Projects
                    </h2>
                    <div class="section-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Search projects..." onkeyup="searchProjects(this.value)">
                        </div>
                        <select class="sort-select" id="sortSelect" onchange="sortProjects(this.value)">
                            <option value="recent">Most Recent</option>
                            <option value="rating">Highest Rated</option>
                            <option value="name">Alphabetical</option>
                        </select>
                    </div>
                </div>
                
                <div class="projects-grid" id="projectsGrid">
                    <!-- Projects will be loaded here -->
                </div>
                
                <div id="no-projects" class="empty-state" style="display: none;">
                    <i class="fas fa-folder-open empty-icon"></i>
                    <h3>No Projects Yet</h3>
                    <p>Be the first to submit a project!</p>
                    <button class="btn btn-primary" onclick="showSubmitModal()">
                        <i class="fas fa-plus"></i> Submit Project
                    </button>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <p>&copy; 2024 Kaspa Ecosystem. Open source project.</p>
                    <p>Built with ‚ù§Ô∏è by the Kaspa community</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Wallet Modal -->
    <div id="wallet-modal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3><i class="fas fa-wallet"></i> Connect Wallet</h3>
                <button class="modal-close" onclick="closeModal('wallet-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="wallet-options">
                    <button class="wallet-option" onclick="connectKasware()">
                        <span class="wallet-icon">üü¢</span>
                        <span>Kasware Wallet</span>
                        <span class="wallet-status" id="kasware-status">Available</span>
                    </button>
                    <button class="wallet-option disabled">
                        <span class="wallet-icon">üè∞</span>
                        <span>Kastle Wallet</span>
                        <span class="wallet-status">Coming Soon</span>
                    </button>
                    <button class="wallet-option disabled">
                        <span class="wallet-icon">üíé</span>
                        <span>KSPR Wallet</span>
                        <span class="wallet-status">Coming Soon</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Project Modal -->
    <div id="submit-modal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3><i class="fas fa-rocket"></i> Submit New Project</h3>
                <button class="modal-close" onclick="closeModal('submit-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="submit-form" onsubmit="submitProject(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project Name <span class="required">*</span></label>
                            <input type="text" name="title" required maxlength="100" placeholder="My Awesome Project">
                        </div>
                        <div class="form-group">
                            <label>Category <span class="required">*</span></label>
                            <select name="category" required id="category-select">
                                <option value="">Select a category</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description <span class="required">*</span></label>
                        <textarea name="description" rows="4" required maxlength="500" placeholder="Describe your project..."></textarea>
                        <small class="form-hint">Max 500 characters</small>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Website URL <span class="required">*</span></label>
                            <input type="url" name="website" required placeholder="https://myproject.com">
                        </div>
                        <div class="form-group">
                            <label>Logo URL</label>
                            <input type="url" name="logo_url" placeholder="https://myproject.com/logo.png">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Social Links</label>
                        <div class="social-grid">
                            <input type="url" name="twitter" placeholder="Twitter/X URL">
                            <input type="url" name="github" placeholder="GitHub URL">
                            <input type="url" name="discord" placeholder="Discord URL">
                            <input type="url" name="telegram" placeholder="Telegram URL">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="terms" required>
                            I confirm this is a legitimate Kaspa ecosystem project
                        </label>
                    </div>
                    
                    <div id="wallet-notice" class="wallet-notice" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        Please connect your wallet to submit a project
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('submit-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="fas fa-paper-plane"></i> Submit Project
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/kaspa-wallet-integration.js"></script>
    
    <script>
        // Global variables
        let app = {
            projects: [],
            categories: {},
            featuredProjects: [],
            walletConnected: false,
            walletAddress: null,
            carouselIndex: 0
        };
        
        // Initialize app
        async function initApp() {
            try {
                console.log('Initializing app...');
                
                // Load data
                await Promise.all([
                    loadCategories(),
                    loadProjects(),
                    checkWalletConnection()
                ]);
                
                // Initialize UI
                renderCategories();
                renderProjects();
                setupCarousel();
                
                // Show app
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error loading application', 'error');
            }
        }
        
        // Load categories
        async function loadCategories() {
            const { data, error } = await supabaseClient
                .from('categories')
                .select('*')
                .order('name');
            
            if (error) throw error;
            
            // Store categories in lookup object
            app.categories = {};
            data.forEach(cat => {
                app.categories[cat.id] = cat;
            });
            
            // Update stats
            document.getElementById('total-categories').textContent = data.length;
            
            // Populate category select
            const select = document.getElementById('category-select');
            select.innerHTML = '<option value="">Select a category</option>' +
                data.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            
            return data;
        }
        
        // Load projects
        async function loadProjects() {
            const { data, error } = await supabaseClient
                .from('projects')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            // Filter valid projects
            app.projects = (data || []).filter(p => p && p.title);
            
            // Update stats
            document.getElementById('total-projects').textContent = app.projects.length;
            document.getElementById('active-users').textContent = 
                new Set(app.projects.map(p => p.submitter_wallet).filter(Boolean)).size;
            
            // Check for featured projects
            const { data: sponsorships } = await supabaseClient
                .from('sponsorships')
                .select('project_id')
                .eq('is_active', true)
                .gte('end_date', new Date().toISOString());
            
            const featuredIds = sponsorships?.map(s => s.project_id) || [];
            app.featuredProjects = app.projects.filter(p => featuredIds.includes(p.id));
            
            return app.projects;
        }
        
        // Render categories
        function renderCategories() {
            const grid = document.getElementById('categoriesGrid');
            const categoriesArray = Object.values(app.categories);
            
            const icons = {
                'wallets': 'fa-wallet',
                'mining': 'fa-hammer',
                'defi': 'fa-coins',
                'nfts': 'fa-image',
                'infrastructure': 'fa-server',
                'education': 'fa-graduation-cap',
                'tools': 'fa-wrench',
                'other': 'fa-cube'
            };
            
            grid.innerHTML = categoriesArray.map(cat => {
                const count = app.projects.filter(p => p.category_id === cat.id).length;
                const icon = icons[cat.slug] || 'fa-cube';
                
                return `
                    <div class="category-card" onclick="filterByCategory(${cat.id})">
                        <i class="fas ${icon} category-icon"></i>
                        <h3 class="category-name">${cat.name}</h3>
                        <p class="category-count">${count} project${count !== 1 ? 's' : ''}</p>
                    </div>
                `;
            }).join('');
        }
        
        // Render projects
        function renderProjects(projects = app.projects) {
            const grid = document.getElementById('projectsGrid');
            const noProjects = document.getElementById('no-projects');
            
            if (projects.length === 0) {
                grid.style.display = 'none';
                noProjects.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            noProjects.style.display = 'none';
            
            grid.innerHTML = projects.map(project => createProjectCard(project)).join('');
        }
        
        // Create project card
        function createProjectCard(project) {
            const category = app.categories[project.category_id] || { name: 'Other' };
            const title = project.title || 'Untitled';
            const firstLetter = title.charAt(0).toUpperCase() || '?';
            const isFeatured = app.featuredProjects.some(p => p.id === project.id);
            
            const logoHtml = project.logo_url 
                ? `<img src="${project.logo_url}" alt="${title}" class="project-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="project-logo-placeholder" style="display: none;">${firstLetter}</div>`
                : `<div class="project-logo-placeholder">${firstLetter}</div>`;
            
            return `
                <div class="project-card" onclick="viewProject(${project.id})">
                    ${isFeatured ? '<span class="featured-badge">‚ú® Featured</span>' : ''}
                    <div class="project-header">
                        ${logoHtml}
                        <div class="project-info">
                            <h3 class="project-title">${title}</h3>
                            <p class="project-category">${category.name}</p>
                        </div>
                    </div>
                    <p class="project-description">${project.description || 'No description available'}</p>
                    <div class="project-stats">
                        <span class="project-stat">
                            <i class="fas fa-eye"></i> ${project.views || 0}
                        </span>
                        <span class="project-stat">
                            <i class="fas fa-star"></i> ${project.average_rating?.toFixed(1) || '0.0'}
                        </span>
                        <span class="project-stat">
                            <i class="fas fa-comment"></i> ${project.comment_count || 0}
                        </span>
                    </div>
                </div>
            `;
        }
        
        // Setup carousel
        function setupCarousel() {
            if (app.featuredProjects.length === 0) {
                document.getElementById('featured').style.display = 'none';
                return;
            }
            
            document.getElementById('featured').style.display = 'block';
            const track = document.getElementById('carouselTrack');
            
            track.innerHTML = app.featuredProjects.map(project => {
                const category = app.categories[project.category_id] || { name: 'Other' };
                return `
                    <div class="carousel-item">
                        <div class="featured-card">
                            <h3>${project.title}</h3>
                            <p class="project-category">${category.name}</p>
                            <p>${project.description || 'No description'}</p>
                            <a href="${project.website}" target="_blank" class="btn btn-primary">
                                Visit Website ‚Üí
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Move carousel
        function moveCarousel(direction) {
            const track = document.getElementById('carouselTrack');
            const items = track.children.length;
            if (items === 0) return;
            
            app.carouselIndex = (app.carouselIndex + direction + items) % items;
            const offset = -app.carouselIndex * 370; // 350px width + 20px gap
            track.style.transform = `translateX(${offset}px)`;
        }
        
        // Search projects
        function searchProjects(query) {
            const filtered = app.projects.filter(p => 
                p.title.toLowerCase().includes(query.toLowerCase()) ||
                (p.description || '').toLowerCase().includes(query.toLowerCase())
            );
            renderProjects(filtered);
        }
        
        // Sort projects
        function sortProjects(sortBy) {
            let sorted = [...app.projects];
            
            switch(sortBy) {
                case 'rating':
                    sorted.sort((a, b) => (b.average_rating || 0) - (a.average_rating || 0));
                    break;
                case 'name':
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                default: // recent
                    sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            
            renderProjects(sorted);
        }
        
        // Filter by category
        function filterByCategory(categoryId) {
            const filtered = app.projects.filter(p => p.category_id === categoryId);
            renderProjects(filtered);
            document.getElementById('projects').scrollIntoView({ behavior: 'smooth' });
        }
        
        // View project details
        function viewProject(projectId) {
            const project = app.projects.find(p => p.id === projectId);
            if (project && project.website) {
                window.open(project.website, '_blank');
            }
        }
        
        // Wallet functions
        async function checkWalletConnection() {
            if (typeof window.kasware !== 'undefined') {
                try {
                    const accounts = await window.kasware.getAccounts();
                    if (accounts.length > 0) {
                        app.walletConnected = true;
                        app.walletAddress = accounts[0];
                        updateWalletUI();
                    }
                } catch (error) {
                    console.error('Error checking wallet:', error);
                }
            }
        }
        
        async function connectKasware() {
            if (typeof window.kasware === 'undefined') {
                showToast('Kasware wallet not found. Please install it first.', 'error');
                window.open('https://kasware.xyz', '_blank');
                return;
            }
            
            try {
                const accounts = await window.kasware.requestAccounts();
                if (accounts.length > 0) {
                    app.walletConnected = true;
                    app.walletAddress = accounts[0];
                    updateWalletUI();
                    closeModal('wallet-modal');
                    showToast('Wallet connected successfully!', 'success');
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showToast('Failed to connect wallet', 'error');
            }
        }
        
        function updateWalletUI() {
            const walletBtn = document.getElementById('wallet-status');
            const walletNotice = document.getElementById('wallet-notice');
            const submitBtn = document.getElementById('submit-btn');
            
            if (app.walletConnected) {
                walletBtn.textContent = app.walletAddress.slice(0, 6) + '...' + app.walletAddress.slice(-4);
                walletNotice.style.display = 'none';
                submitBtn.disabled = false;
            } else {
                walletBtn.textContent = 'Connect';
                walletNotice.style.display = 'block';
                submitBtn.disabled = true;
            }
        }
        
        // Submit project
        async function submitProject(event) {
            event.preventDefault();
            
            if (!app.walletConnected) {
                showToast('Please connect your wallet first', 'warning');
                showWalletModal();
                return;
            }
            
            const form = event.target;
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const formData = new FormData(form);
                const projectData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    website: formData.get('website'),
                    logo_url: formData.get('logo_url') || null,
                    twitter: formData.get('twitter') || null,
                    github: formData.get('github') || null,
                    discord: formData.get('discord') || null,
                    telegram: formData.get('telegram') || null,
                    category_id: parseInt(formData.get('category')),
                    submitter_wallet: app.walletAddress,
                    slug: formData.get('title').toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '')
                };
                
                const { data, error } = await supabaseClient
                    .from('projects')
                    .insert([projectData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Project submitted successfully!', 'success');
                form.reset();
                closeModal('submit-modal');
                
                // Reload projects
                await loadProjects();
                renderProjects();
                
            } catch (error) {
                console.error('Error submitting project:', error);
                showToast(error.message || 'Failed to submit project', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Project';
            }
        }
        
        // UI Helper functions
        function showWalletModal() {
            // Check if Kasware is installed
            if (typeof window.kasware !== 'undefined') {
                document.getElementById('kasware-status').textContent = 'Click to connect';
            } else {
                document.getElementById('kasware-status').textContent = 'Not installed';
            }
            document.getElementById('wallet-modal').classList.add('show');
        }
        
        function showSubmitModal() {
            updateWalletUI();
            document.getElementById('submit-modal').classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function toggleMobileMenu() {
            const navMenu = document.getElementById('navMenu');
            const navToggle = document.getElementById('navToggle');
            navMenu.classList.toggle('active');
            navToggle.classList.toggle('active');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Close modals on outside click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
